<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>성경 읽기 달력 (웹 버전)</title>
  <style>
    body { font-family: "맑은 고딕", sans-serif; margin: 20px; background: #f9f9f9; }
    .container { max-width: 380px; margin: auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .header { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
    select, button { font-size: 16px; padding: 6px; }
    .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: bold; margin: 10px 0; }
    .grid { display: grid; grid-template-columns: repeat(7, 50px); gap: 2px; }
    .cell {
      width: 48px; height: 46px; border: 1px solid #ccc; text-align: center;
      display: flex; flex-direction: column; justify-content: space-between;
      background: white; cursor: pointer; font-size: 13px;
    }
    .date { font-weight: bold; height: 28px; line-height: 28px; }
    .memo { background: #539ad9; color: white; height: 18px; line-height: 18px; font-size: 11px; }
    .footer { display: flex; justify-content: space-between; margin-top: 20px; align-items: center; }
    .today { color: blue; font-size: 18px; font-weight: bold; }
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none;
      justify-content: center; align-items: center; z-index: 1000;
    }
    .modal-content {
      background: white; padding: 20px; max-width: 700px; max-height: 80vh;
      overflow-y: auto; border-radius: 8px; position: relative;
    }
    .close { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; }
  </style>
</head>
<body>

<div class="container">
  <h2 style="text-align:center; margin-bottom:10px;">성경 읽기 달력 (6주)</h2>

  <div class="header">
    <select id="maxDays">
      <option>28</option><option>29</option><option>30</option><option selected>31</option>
    </select>
    <select id="month">
      <option>1월</option><option>2월</option><option>3월</option><option>4월</option>
      <option>5월</option><option>6월</option><option>7월</option><option>8월</option>
      <option>9월</option><option>10월</option><option>11월</option><option>12월</option>
    </select>
    <select id="book"></select>
    <select id="chapter"></select>
  </div>

  <div class="weekdays">
    <div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div>
  </div>

  <div class="grid" id="grid"></div>

  <div class="footer">
    <button id="reset">초기화</button>
    <div class="today" id="today"></div>
  </div>
</div>

<!-- 장 내용 모달 -->
<div class="modal" id="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">×</span>
    <h3 id="modalTitle"></h3>
    <pre id="modalContent" style="white-space: pre-wrap; font-family: inherit;"></pre>
  </div>
</div>

<script>
// ── 데이터 (실제로는 HKJVbible.json 등을 fetch로 불러와야 함) ──
const BibleData = {}; // 여기에 JSON 파싱 결과 넣기
// 예시: fetch('HKJVbible.json').then(r=>r.json()).then(d=>Object.assign(BibleData,d))

// BookList, BookMap, BookChapterCount는 별도 파일에서 가져왔다 가정
const BookList = ["창세기","출애굽기","레위기" /* ... 실제 Books.ahk 내용 */];
const BookMap = { "창세기":"GEN", "출애굽기":"EXO" /* ... */ };
const BookChapterCount = { "창세기":50, "출애굽기":40 /* ... */ };

const dateCells = [];
const memoCells = [];
const grid = document.getElementById("grid");
const modal = document.getElementById("modal");
const modalTitle = document.getElementById("modalTitle");
const modalContent = document.getElementById("modalContent");

// 그리드 생성
for(let i=0; i<42; i++){
  const cell = document.createElement("div");
  cell.className = "cell";
  const dateDiv = document.createElement("div"); dateDiv.className = "date";
  const memoDiv = document.createElement("div"); memoDiv.className = "memo";
  cell.appendChild(dateDiv);
  cell.appendChild(memoDiv);
  grid.appendChild(cell);
  dateCells.push(dateDiv);
  memoCells.push(memoDiv);

  dateDiv.addEventListener("click", ()=>handleDateClick(i));
  memoDiv.addEventListener("click", ()=>handleMemoClick(i));
}

// 책 선택지 채우기
const bookSel = document.getElementById("book");
BookList.forEach(b=> {
  const opt = document.createElement("option");
  opt.textContent = b;
  bookSel.appendChild(opt);
});
bookSel.value = BookList[0];

// 책 변경 시 장 목록 갱신
bookSel.onchange = updateChapters;
function updateChapters(){
  const book = bookSel.value;
  const maxCh = BookChapterCount[book] || 150;
  const chSel = document.getElementById("chapter");
  chSel.innerHTML = "";
  for(let i=1; i<=maxCh; i++){
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = i + "장";
    chSel.appendChild(opt);
  }
  chSel.value = 1;
}
updateChapters();

// 월 변경 시 최대일수 조정 + 오늘 표시 갱신
const monthSel = document.getElementById("month");
monthSel.onchange = updateMonth;
function updateMonth(){
  const m = parseInt(monthSel.value);
  let days = 31;
  if(m===2) days=28;
  else if([4,6,9,11].includes(m)) days=30;
  document.getElementById("maxDays").value = days;
  updateToday();
}

// 오늘 날짜 표시 (실시간)
function updateToday(){
  const now = new Date();
  const m = now.getMonth()+1;
  const d = now.getDate();
  document.getElementById("today").textContent = `${m}월 ${d}일`;
}
setInterval(updateToday, 60000); // 1분마다 갱신
updateToday();

// 셀 클릭 - 일반: 시작부터 순차 채우기
function handleDateClick(idx){
  // 이미 채워져 있으면 무시 (원본 로직 따라)
  if(dateCells.some(el=>el.textContent.trim() !== "")) return;

  let day = 1;
  let ch = parseInt(document.getElementById("chapter").value);
  const maxCh = BookChapterCount[bookSel.value] || 150;

  for(let i=idx; i<42; i++){
    if(day > parseInt(document.getElementById("maxDays").value)) break;
    if(ch > maxCh) break;
    dateCells[i].textContent = day;
    memoCells[i].textContent = ch + "장";
    day++;
    ch++;
  }
  saveState();
}

// 메모 클릭 → 장 내용 보기
function handleMemoClick(idx){
  const txt = memoCells[idx].textContent.trim();
  if(!txt) return;
  const chNum = parseInt(txt);
  const book = bookSel.value;
  const abbr = BookMap[book];
  if(!abbr) return alert("책 매핑 정보 없음");

  modalTitle.textContent = `${book} ${chNum}장`;
  let html = "";
  // 실제 데이터가 없으므로 placeholder
  // 실제로는 BibleData[abbr + chNum + ":1"] 등으로 순회
  html = "(여기에 " + book + " " + chNum + "장 내용이 표시됩니다)\n\n1절 내용 예시...\n2절...";
  modalContent.textContent = html;
  modal.style.display = "flex";
}

function closeModal(){ modal.style.display = "none"; }

// 초기화
document.getElementById("reset").onclick = ()=>{
  dateCells.forEach(el=>el.textContent="");
  memoCells.forEach(el=>el.textContent="");
  saveState();
  alert("달력이 초기화되었습니다.");
};

// 저장 / 불러오기 (localStorage)
function saveState(){
  const state = {
    month: monthSel.value,
    maxDays: document.getElementById("maxDays").value,
    book: bookSel.value,
    startChapter: document.getElementById("chapter").value,
    dates: dateCells.map(el=>el.textContent.trim()),
    memos: memoCells.map(el=>el.textContent.trim())
  };
  localStorage.setItem("bibleCalendar", JSON.stringify(state));
}

function loadState(){
  const saved = localStorage.getItem("bibleCalendar");
  if(!saved) return;
  const state = JSON.parse(saved);
  monthSel.value = state.month || "1월";
  document.getElementById("maxDays").value = state.maxDays || "31";
  bookSel.value = state.book || BookList[0];
  document.getElementById("chapter").value = state.startChapter || "1";
  updateChapters();
  updateMonth();

  state.dates?.forEach((v,i)=> dateCells[i].textContent = v);
  state.memos?.forEach((v,i)=> memoCells[i].textContent = v);
}
loadState();

// 처음 로드 시
updateMonth();
</script>
</body>
</html>
