<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>성경 읽기 달력 (웹 버전)</title>
<script>
// ── 데이터 (기존 그대로) ────────────────────────────────────────
const BookList = [ /* ... 기존 BookList 배열 그대로 ... */ ];
const BookMap = { /* ... 기존 BookMap 객체 그대로 ... */ };
const BookChapterCount = { /* ... 기존 BookChapterCount 객체 그대로 ... */ };

let BibleData = {};

// 그리드 셀 생성 (기존 그대로)
const grid = document.getElementById("grid");
const dateCells = [];
const memoCells = [];

for (let i = 0; i < 42; i++) {
  const cell = document.createElement("div");
  cell.className = "cell";
  const dateDiv = document.createElement("div"); dateDiv.className = "date";
  const memoDiv = document.createElement("div"); memoDiv.className = "memo";
  cell.appendChild(dateDiv);
  cell.appendChild(memoDiv);
  grid.appendChild(cell);
  dateCells.push(dateDiv);
  memoCells.push(memoDiv);

  cell.addEventListener("click", (e) => {
    // 메모 부분 클릭 시 handleMemoClick, 나머지 영역은 handleDateClick
    if (e.target.classList.contains("memo") || e.target.parentElement.classList.contains("memo")) {
      handleMemoClick(i);
    } else {
      handleDateClick(i);
    }
  });
}

// 책 드롭다운 채우기
const bookSel = document.getElementById("book");
BookList.forEach(b => {
  const opt = document.createElement("option");
  opt.textContent = b;
  bookSel.appendChild(opt);
});

// 장 드롭다운 업데이트 함수
function updateChapters() {
  const book = bookSel.value;
  const max = BookChapterCount[book] || 150;
  const chSel = document.getElementById("chapter");
  chSel.innerHTML = "";
  for (let i = 1; i <= max; i++) {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = i + "장";
    chSel.appendChild(opt);
  }
  // 선택값이 범위 밖이면 1로 강제
  if (chSel.value === "") chSel.value = 1;
}

// 월 변경 시 최대일수 조정
function updateMaxDays() {
  const m = parseInt(document.getElementById("month").value);
  let days = 31;
  if (m === 2) days = 28;
  else if ([4,6,9,11].includes(m)) days = 30;
  document.getElementById("maxDays").value = days;
}

// 오늘 날짜 표시
function updateToday() {
  const now = new Date();
  document.getElementById("today").textContent = `${now.getMonth()+1}월 ${now.getDate()}일`;
}
setInterval(updateToday, 60000);
updateToday();

// ── 설정 저장 / 불러오기 ──────────────────────────────────────────
function saveSettings() {
  const state = {
    book: bookSel.value,
    chapter: document.getElementById("chapter").value,
    month: document.getElementById("month").value,
    maxDays: document.getElementById("maxDays").value,
    // 달력 내용은 별도로 저장 (기존 saveState)
  };
  localStorage.setItem("bibleCalendarSettings", JSON.stringify(state));
}

function loadSettings() {
  const saved = localStorage.getItem("bibleCalendarSettings");
  if (!saved) return;

  const state = JSON.parse(saved);

  if (state.book && BookList.includes(state.book)) {
    bookSel.value = state.book;
  }
  updateChapters();  // 책 바꾼 후 장 목록 갱신

  if (state.chapter) {
    const chSel = document.getElementById("chapter");
    if ([...chSel.options].some(opt => opt.value == state.chapter)) {
      chSel.value = state.chapter;
    } else {
      chSel.value = "1";
    }
  }

  if (state.month) {
    document.getElementById("month").value = state.month;
  }

  if (state.maxDays) {
    document.getElementById("maxDays").value = state.maxDays;
  }

  updateMaxDays();   // 월에 따라 maxDays 재조정
  updateToday();     // 오늘 날짜 갱신
}

// ── 이벤트 연결 ───────────────────────────────────────────────────
bookSel.addEventListener("change", () => {
  updateChapters();
  saveSettings();
});

document.getElementById("chapter").addEventListener("change", saveSettings);
document.getElementById("month").addEventListener("change", () => {
  updateMaxDays();
  updateToday();
  saveSettings();
});
document.getElementById("maxDays").addEventListener("change", saveSettings);

// ── 페이지 로드 시 복원 ───────────────────────────────────────────
loadSettings();

// ── 달력 내용 저장/로드 (기존 saveState / loadState 그대로 유지) ──
function saveState() {
  const state = {
    dates: dateCells.map(d => d.textContent.trim()),
    memos: memoCells.map(m => m.textContent.trim())
  };
  localStorage.setItem("bibleCalendarGrid", JSON.stringify(state));
}

function loadState() {
  const saved = localStorage.getItem("bibleCalendarGrid");
  if (saved) {
    const state = JSON.parse(saved);
    state.dates?.forEach((v, i) => { if (v) dateCells[i].textContent = v; });
    state.memos?.forEach((v, i) => { if (v) memoCells[i].textContent = v; });
  }
}
loadState();

// 초기화 버튼
document.getElementById("reset").onclick = () => {
  dateCells.forEach(d => d.textContent = "");
  memoCells.forEach(m => m.textContent = "");
  saveState();
  alert("달력이 초기화되었습니다.");
};

// JSON 불러오기 (기존 그대로)
fetch('HRVbible.json')
  .then(r => r.ok ? r.json() : Promise.reject("파일 로드 실패"))
  .then(data => { BibleData = data; console.log("성경 데이터 로드 완료"); })
  .catch(err => console.error("JSON 오류:", err));

// handleDateClick, handleMemoClick 함수는 기존 그대로 유지
// (필요하면 이전 메시지에서 복사해서 붙여넣기)
</script>
// ── 데이터 (AHK → JS 변환) ────────────────────────────────────────
const BookList = ["창세기","출애굽기","레위기","민수기","신명기","여호수아","사사기","룻기","사무엘상","사무엘하","열왕기상","열왕기하","역대상","역대하","에스라","느헤미야","에스더","욥기","시편","잠언","전도서","아가","이사야","예레미야","예레미야애가","에스겔","다니엘","호세아","요엘","아모스","오바댜","요나","미가","나훔","하박국","스바냐","학개","스가랴","말라기","마태복음","마가복음","누가복음","요한복음","사도행전","로마서","고린도전서","고린도후서","갈라디아서","에베소서","빌립보서","골로새서","데살로니가전서","데살로니가후서","디모데전서","디모데후서","디도서","빌레몬서","히브리서","야고보서","베드로전서","베드로후서","요한일서","요한이서","요한삼서","유다서","요한계시록"];

const BookMap = {"창세기":"창","출애굽기":"출","레위기":"레","민수기":"민","신명기":"신","여호수아":"수","사사기":"삿","룻기":"룻","사무엘상":"삼상","사무엘하":"삼하","열왕기상":"왕상","열왕기하":"왕하","역대상":"대상","역대하":"대하","에스라":"스","느헤미야":"느","에스더":"에","욥기":"욥","시편":"시","잠언":"잠","전도서":"전","아가":"아","이사야":"사","예레미야":"렘","예레미야애가":"애","에스겔":"겔","다니엘":"단","호세아":"호","요엘":"욜","아모스":"암","오바댜":"옵","요나":"욘","미가":"미","나훔":"나","하박국":"합","스바냐":"습","학개":"학","스가랴":"슥","말라기":"말","마태복음":"마","마가복음":"막","누가복음":"눅","요한복음":"요","사도행전":"행","로마서":"롬","고린도전서":"고전","고린도후서":"고후","갈라디아서":"갈","에베소서":"엡","빌립보서":"빌","골로새서":"골","데살로니가전서":"살전","데살로니가후서":"살후","디모데전서":"딤전","디모데후서":"딤후","디도서":"딛","빌레몬서":"몬","히브리서":"히","야고보서":"약","베드로전서":"벧전","베드로후서":"벧후","요한일서":"요일","요한이서":"요이","요한삼서":"요삼","유다서":"유","요한계시록":"계"};

const BookChapterCount = {"창세기":50,"출애굽기":40,"레위기":27,"민수기":36,"신명기":34,"여호수아":24,"사사기":21,"룻기":4,"사무엘상":31,"사무엘하":24,"열왕기상":22,"열왕기하":25,"역대상":29,"역대하":36,"에스라":10,"느헤미야":13,"에스더":10,"욥기":42,"시편":150,"잠언":31,"전도서":12,"아가":8,"이사야":66,"예레미야":52,"예레미야애가":5,"에스겔":48,"다니엘":12,"호세아":14,"요엘":3,"아모스":9,"오바댜":1,"요나":4,"미가":7,"나훔":3,"하박국":3,"스바냐":3,"학개":2,"스가랴":14,"말라기":4,"마태복음":28,"마가복음":16,"누가복음":24,"요한복음":21,"사도행전":28,"로마서":16,"고린도전서":16,"고린도후서":13,"갈라디아서":6,"에베소서":6,"빌립보서":4,"골로새서":4,"데살로니가전서":5,"데살로니가후서":3,"디모데전서":6,"디모데후서":4,"디도서":3,"빌레몬서":1,"히브리서":13,"야고보서":5,"베드로전서":5,"베드로후서":3,"요한일서":5,"요한이서":1,"요한삼서":1,"유다서":1,"요한계시록":22};

let BibleData = {};

// 그리드 셀 생성
const grid = document.getElementById("grid");
const dateCells = [];
const memoCells = [];

for (let i = 0; i < 42; i++) {
  const cell = document.createElement("div");
  cell.className = "cell";
  const dateDiv = document.createElement("div"); dateDiv.className = "date";
  const memoDiv = document.createElement("div"); memoDiv.className = "memo";
  cell.appendChild(dateDiv);
  cell.appendChild(memoDiv);
  grid.appendChild(cell);
  dateCells.push(dateDiv);
  memoCells.push(memoDiv);

  dateDiv.parentElement.addEventListener("click", () => handleDateClick(i));
  memoDiv.parentElement.addEventListener("click", () => handleMemoClick(i));
}

// 책 드롭다운 채우기
const bookSel = document.getElementById("book");
BookList.forEach(b => {
  const opt = document.createElement("option");
  opt.textContent = b;
  bookSel.appendChild(opt);
});
bookSel.value = BookList[0];

// 장 드롭다운 업데이트
function updateChapters() {
  const book = bookSel.value;
  const max = BookChapterCount[book] || 150;
  const chSel = document.getElementById("chapter");
  chSel.innerHTML = "";
  for (let i = 1; i <= max; i++) {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = i + "장";
    chSel.appendChild(opt);
  }
  chSel.value = 1;
}
bookSel.addEventListener("change", updateChapters);
updateChapters();

// 월 변경 시 일수 조정 + 오늘 갱신
document.getElementById("month").addEventListener("change", updateMonthAndToday);
function updateMonthAndToday() {
  const m = parseInt(document.getElementById("month").value);
  let days = 31;
  if (m === 2) days = 28;
  else if ([4,6,9,11].includes(m)) days = 30;
  document.getElementById("maxDays").value = days;
  updateToday();
}

// 오늘 날짜 실시간 표시
function updateToday() {
  const now = new Date();
  document.getElementById("today").textContent = `${now.getMonth()+1}월 ${now.getDate()}일`;
}
setInterval(updateToday, 60000);
updateToday();

// 날짜 셀 클릭 (시작부터 채우기)
function handleDateClick(startIdx) {
  if (dateCells.some(d => d.textContent.trim() !== "")) return; // 이미 채워짐

  let day = 1;
  let ch = parseInt(document.getElementById("chapter").value);
  const maxCh = BookChapterCount[bookSel.value] || 150;
  const maxDays = parseInt(document.getElementById("maxDays").value);

  for (let i = startIdx; i < 42; i++) {
    if (day > maxDays || ch > maxCh) break;
    dateCells[i].textContent = day;
    memoCells[i].textContent = ch + "장";
    day++;
    ch++;
  }
  saveState();
}

// 메모 클릭 → 모달
function handleMemoClick(idx) {
  const txt = memoCells[idx].textContent.trim();
  if (!txt) return;

  const chNum = parseInt(txt);
  const book = bookSel.value;
  const abbr = BookMap[book];
  const titleEl = document.getElementById("modalTitle");
  const contentEl = document.getElementById("modalContent");

  titleEl.textContent = `${book} ${chNum}장`;

  if (Object.keys(BibleData).length === 0) {
    contentEl.textContent = "성경 데이터 로딩 중... 잠시 후 다시 클릭해주세요.";
  } else {
    let text = "";
    const prefix = abbr + chNum + ":";
    for (let key in BibleData) {
      if (key.startsWith(prefix)) {
        const verse = key.split(":")[1];
        text += `${verse}  ${BibleData[key]}\n\n`;
      }
    }
    contentEl.textContent = text || "해당 장 내용이 없습니다.";
  }

  document.getElementById("modal").style.display = "flex";
}

// 초기화
document.getElementById("reset").onclick = () => {
  dateCells.forEach(d => d.textContent = "");
  memoCells.forEach(m => m.textContent = "");
  saveState();
  alert("달력이 초기화되었습니다.");
};

// localStorage 저장/로드 (간단 버전)
function saveState() {
  const state = {
    dates: dateCells.map(d => d.textContent.trim()),
    memos: memoCells.map(m => m.textContent.trim())
  };
  localStorage.setItem("bibleCalendar", JSON.stringify(state));
}

function loadState() {
  const saved = localStorage.getItem("bibleCalendar");
  if (saved) {
    const state = JSON.parse(saved);
    state.dates?.forEach((v, i) => { if (v) dateCells[i].textContent = v; });
    state.memos?.forEach((v, i) => { if (v) memoCells[i].textContent = v; });
  }
}
loadState();

// HRVbible.json 불러오기
fetch('HRVbible.json')
  .then(r => r.ok ? r.json() : Promise.reject("파일 로드 실패"))
  .then(data => { BibleData = data; console.log("성경 데이터 로드 완료"); })
  .catch(err => console.error("JSON 오류:", err));
</script>
</body>
</html>
